## -*- mode: shell-script; -*- 
##
## To be able to make changes to the part of configuration created
## from this configlet you need to copy this file to the directory
## fwbuilder/configlets/nftables/ in your home directory and modify it.
## Double "##" comments are removed during processing but single "#"
## comments are be retained and appear in the generated script. Empty
## lines are removed as well.  
##
## Configlets support simple macro language with these constructs:
## {{$var}} is variable expansion
## {{if var}} is conditional operator.
##
## This configlet defines commands executed when nftables script is ran
## with command line argument "stop". By default it resets nftables
## ruleset using function reset_all and sets base chain policy to ACCEPT.

stop_action() {
    reset_all

{{if have_ipv4}}
    $NFT list table ip filter >/dev/null 2>&1 || $NFT add table ip filter
    $NFT list chain ip filter INPUT >/dev/null 2>&1 || \
        $NFT add chain ip filter INPUT { type filter hook input priority 0; policy accept; }
    $NFT list chain ip filter OUTPUT >/dev/null 2>&1 || \
        $NFT add chain ip filter OUTPUT { type filter hook output priority 0; policy accept; }
    $NFT list chain ip filter FORWARD >/dev/null 2>&1 || \
        $NFT add chain ip filter FORWARD { type filter hook forward priority 0; policy accept; }
{{endif}}

{{if have_ipv6}}
    $NFT list table ip6 filter >/dev/null 2>&1 || $NFT add table ip6 filter
    $NFT list chain ip6 filter INPUT >/dev/null 2>&1 || \
        $NFT add chain ip6 filter INPUT { type filter hook input priority 0; policy accept; }
    $NFT list chain ip6 filter OUTPUT >/dev/null 2>&1 || \
        $NFT add chain ip6 filter OUTPUT { type filter hook output priority 0; policy accept; }
    $NFT list chain ip6 filter FORWARD >/dev/null 2>&1 || \
        $NFT add chain ip6 filter FORWARD { type filter hook forward priority 0; policy accept; }
{{endif}}
}
