## -*- mode: shell-script; -*- 
##
## To be able to make changes to the part of configuration created
## from this configlet you need to copy this file to the directory
## fwbuilder/configlets/nftables/ in your home directory and modify it.
## Double "##" comments are removed during processing but single "#"
## comments are be retained and appear in the generated script. Empty
## lines are removed as well.  
##
## Configlets support simple macro language with these constructs:
## {{$var}} is variable expansion
## {{if var}} is conditional operator.
##
## This configlet defines commands executed when nftables script is ran
## with command line argument "block". By default it resets nftables
## ruleset using function reset_all and optionally adds backup
## ssh access rules.

block_action() {
    reset_all

## it helps to add backup ssh access rule as early as possible so that
## ssh session opened from the management station won't break after
## all chains are flushed. The installation process may stall if
## stdout buffer gets filled with diagnostic or progress output from
## this script printed after chains are flushed but before a rule
## permitting ssh is installed. This may happen if script debugging is
## on or there are many NAT rules (so it prints a lot of "Rule NN
## (NAT)" lines).

{{if have_ipv4}}
    $NFT list table ip filter >/dev/null 2>&1 || $NFT add table ip filter
    $NFT list chain ip filter INPUT >/dev/null 2>&1 || \
        $NFT add chain ip filter INPUT { type filter hook input priority 0; policy drop; }
    $NFT list chain ip filter OUTPUT >/dev/null 2>&1 || \
        $NFT add chain ip filter OUTPUT { type filter hook output priority 0; policy drop; }
    $NFT list chain ip filter FORWARD >/dev/null 2>&1 || \
        $NFT add chain ip filter FORWARD { type filter hook forward priority 0; policy drop; }
{{endif}}

{{if have_ipv6}}
    $NFT list table ip6 filter >/dev/null 2>&1 || $NFT add table ip6 filter
    $NFT list chain ip6 filter INPUT >/dev/null 2>&1 || \
        $NFT add chain ip6 filter INPUT { type filter hook input priority 0; policy drop; }
    $NFT list chain ip6 filter OUTPUT >/dev/null 2>&1 || \
        $NFT add chain ip6 filter OUTPUT { type filter hook output priority 0; policy drop; }
    $NFT list chain ip6 filter FORWARD >/dev/null 2>&1 || \
        $NFT add chain ip6 filter FORWARD { type filter hook forward priority 0; policy drop; }
{{endif}}

{{if mgmt_access}}
{{if have_ipv4}}
    # backup ssh access
    $NFT add rule ip filter INPUT ip saddr {{$ssh_management_address}} tcp dport 22 ct state { new, established } accept
    $NFT add rule ip filter OUTPUT ip daddr {{$ssh_management_address}} tcp sport 22 ct state { established, related } accept
{{endif}}
{{if have_ipv6}}
    # backup ssh access
    $NFT add rule ip6 filter INPUT ip6 saddr {{$ssh_management_address}} tcp dport 22 ct state { new, established } accept
    $NFT add rule ip6 filter OUTPUT ip6 daddr {{$ssh_management_address}} tcp sport 22 ct state { established, related } accept
{{endif}}
{{endif}}
}
