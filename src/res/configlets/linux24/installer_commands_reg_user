## -*- mode: shell-script; -*- 
##
## Lines that start with "##" will be removed before this code is
## added to the generated script. Regular shell comments can be added
## using single "#", these will appear in the script.
##
##
## These are commands built-in policy installer runs on the firewall if
## installation is performed using regular user account for authentication
##
##  Variables:
##
##  {{$fwbprompt}} -- "magic" prompt that installer uses to detect when it is logged in
##  {{$fwdir}}     -- directory on the firewall
##  {{$fwscript}}  -- script name on the firewall
##  {{$rbtimeout}} -- rollback timeout
##
##  {{$firewall_name}} -- the name of the firewall object
##
##  Note: all commands should be on one line to avoid unnecessary linefeeds.
##  These linefeeds are sent to the server side (to the firewall) and end up
##  on the input of sudo and other commands. This creates difficult to catch
##  race condition which breaks installation process.

{{if install_systemd_unit}}echo '{{$fwbprompt}}'; chmod +x {{$fwdir}}/{{$fwscript}}; sudo -S sh -c "printf '[Unit]\nDescription=Firewall Builder policy for {{$firewall_name}}\nAfter=network.target\n\n[Service]\nType=oneshot\nExecStart={{$fwdir}}/{{$fwscript}}\nRemainAfterExit=yes\n\n[Install]\nWantedBy=multi-user.target\n' > /etc/systemd/system/fwbuilder-{{$firewall_name}}.service"; sudo -S systemctl daemon-reload; sudo -S systemctl enable --now fwbuilder-{{$firewall_name}}.service && echo 'Policy activated'{{endif}}{{if no_install_systemd_unit}}echo '{{$fwbprompt}}'; chmod +x {{$fwdir}}/{{$fwscript}}; sudo -S {{$fwdir}}/{{$fwscript}} && echo 'Policy activated'{{endif}}
